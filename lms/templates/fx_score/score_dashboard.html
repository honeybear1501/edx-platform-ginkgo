## mako
<%! from django.utils.translation import ugettext as _ %>
<%namespace name='static' file='/static_content.html'/>
<%inherit file="/main.html" />
<%block name="bodyclass">score is-in-course course</%block>
<%block name="pagetitle">${_("SCORE")}</%block>
<%static:css group='style-course'/>
<%block name="headextra">
</%block>
<%include file="/courseware/course_navigation.html" args="active_page='score'" />

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<style>
  button {
    box-shadow: none !important;
    background-image: none !important;
  }
</style>

<!-- Main View -->
<div class="container" id="main-page"> 
  <div class="card">
    <div class="card-body text-center">
      <h4 class="card-title">Danh sách bài nộp của môn ABC</h4>
      <p class="card-text">
        With supporting text below as a natural lead-in to additional
        content.
      </p>
    </div>
  </div>
  <div class="container mt-4">
    <div class="row">
      <div class="col-md-12">
        <div class="shadow-sm p-3 mb-5 bg-body rounded">
          Màn hình Danh sách mới
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-12">
        <div class="card">
          <div class="card-body">
            <div class="card-content">
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">STT</th>
                    <th scope="col">Thành phần điểm</th>
                    <th scope="col">Trạng thái</th>
                    <th scope="col">Hành động</th>
                  </tr>
                </thead>
                <tbody id="table-1-body">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Details View -->
<div class="container" id="view-page" style="display: none;">
  <div class="card">
    <div class="card-body text-center">
      <h4 class="card-title">Xem thông tin bài nộp</h4>
      <p class="card-text">
        With supporting text below as a natural lead-in to additional
        content.
      </p>
    </div>
  </div>
  <div class="container mt-4">
    <div class="row">
      <div class="col-sm-6">
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-sm-6 col-md-4"><b>Thành phần điểm: </b></div>
              <div class="col-sm-6 col-md-4" id="title"></div>
            </div>
            <div class="row mt-2">
              <div class="col-sm-6 col-md-4"><b>Môn học:</b></div>
              <div class="col-sm-6 col-md-4" id="course-code"></div>
            </div>
            <div class="row mt-3">
              <div class="col-sm-6 col-md-4"><b>Email học viên:</b></div>
              <div class="col-sm-6 col-md-4">HVFx200@gmail.com</div>
            </div>
            <div class="row mt-3">
              <div class="col-sm-6 col-md-4">
                <b>File nộp của học viên</b>
              </div>
              <div class="col-sm-6 col-md-4">
                <button type="button" class="btn btn-link">Link tải</button>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-sm-6 col-md-4">
                <b>Thời điểm đăng ký review:</b>
              </div>
              <div class="col-sm-6 col-md-4" id="date-register"></div>
            </div>
            <div class="row mt-3">
              <div class="col-sm-6 col-md-4"><b>Thời điểm review</b></div>
              <div class="col-sm-6 col-md-4" id="datetime-interview"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-sm-6">
        <div class="card">
          <div class="card-body">
            <div class="row mt-3">
              <div class="col-sm-6 col-md-4"><b>Lần review:</b></div>
              <div class="col-sm-6 col-md-4" id="review-times"></div>
            </div>
            <div class="row mt-3">
              <div class="col-sm-6 col-md-4"><b>Email Mentor:</b></div>
              <div class="col-sm-6 col-md-4" id="mentor-email"></div>
            </div>
            <div class="row mt-3" id="select-form">
              <div class="col-sm-6 col-md-4"><b> Option đã chọn:</b></div>
              <div class="col-sm-6 col-md-4" id="option"></div>
            </div>
            <div class="row mt-3">
              <div class="col-sm-6 col-md-4"><b>Điểm:</b></div>
              <div class="col-sm-6 col-md-4" id="mark"></div>
            </div>
            <div class="row mt-3">
              <div class="col-sm-6 col-md-4"><b>Nhận xét:</b></div>
              <div class="col-sm-6 col-md-4" id="comment"></div>
            </div>
            <div class="row mt-3">
              <div class="col-sm-6 col-md-4"><b>Trạng thái:</b></div>
              <div class="col-sm-6 col-md-4" id="status-button">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row" id="details-view">
      <div class="col-sm-12">
        <div class="card col-md-12 mt-4 mb-2">
          <div class="card-body">
            <h5 class="card-title text-bg-light">Chi tiết bài chấm</h5>
            <div class="card-content">
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Trọng số</th>
                    <th scope="col">Mô tả tiêu chí</th>
                    <th scope="col">Điểm</th>
                    <th scope="col">Nhận xét</th>
                    <th scope="col">Tiêu chí bắt buộc?</th>
                  </tr>
                </thead>
                <tbody id="details">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Submit Files View -->
<div class="container" id="submit-file-page" style="display: none;">
  <div class="card">
    <div class="card-body text-center">
      <h5 class="card-title">Nộp file</h5>
      <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
    </div>
  </div>
  <div class="card mt-4">
    <div class="card-body">
        <div class="container mt-4">
          <div class="row">
            <div class="col-sm-6 col-md-4"><b>Thành phần điểm: </b></div>
            <div class="col-sm-6 col-md-4" id="submit-view-title"></div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-6 col-md-4"><b>Email học viên:</b></div>
            <div class="col-sm-6 col-md-4" id="submit-view-email">MinhAnhFx20338@gmail.com</div>
          </div>
          <div class="row mt-3">
            <div class="col-sm-6 col-md-4">Option</div>
            <div class="col-sm-6 col-md-4">
              <select class="form-select" aria-label="Default select example">
                <option selected>Chọn option</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-6 col-md-4">File đính kèm</div>
            <div class="col-sm-6 col-md-4">
              <input class="form-control" type="file" id="formFile">
            </div>
          </div>
        </div>
    </div>
  </div>
</div>

<!-- Booking Interview View -->
<div class="container" id="book-page" style="display: none;">
  <div class="card">
    <div class="card-body text-center">
      <h5 class="card-title">Đặt một lịch phiên review</h5>
      <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
    </div>
  </div>
  <div class="card mt-4">
      <div class="card-body">
          <div class="container mt-4">
            <div class="row">
              <div class="col-sm-6 col-md-4"><b>Thành phần điểm: </b></div>
              <div class="col-sm-6 col-md-4">Assignment 3</div>
            </div>
            <div class="row mt-2">
              <div class="col-sm-6 col-md-4"><b>Email học viên:</b></div>
              <div class="col-sm-6 col-md-4">MinhAnhFx20338@gmail.com</div>
            </div>
            <div class="row mt-3">
              <div class="col-sm-6 col-md-4">Lần review:</div>
              <div class="col-sm-6 col-md-4">2/2</div>
            </div>
            <div class="row mt-2">
              <div class="col-sm-6 col-md-4">Thời gian Interview</div>
              <div class="col-sm-6 col-md-4">
                  <button type="button" class="btn btn-light">Chọn ngày</button>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-sm-6 col-md-4">Thời buổi (Nếu chọn Thứ 7)</div>
              <div class="col-sm-6 col-md-4">
                  <button type="button" class="btn btn-light">Chọn buổi</button>
              </div>
            </div>
          </div>
      </div>
  </div>
  <div class="row mt-5">
      <div class="col-6 col-sm-3">
          <button type="button" class="btn btn-warning btn-lg mx-2">Đặt lịch</button>
      </div>
  </div>
</div>

<script type="text/javascript">
  fetch('http://51.79.153.64:3000/asmList')
  .then(res => res.json())
  .then(data => {
    const list = data.assessment_element_list;
    for(let i = 0; i < list.length; i++){
      const value = list[i];
      const title = value.asssessment_element_title;
      const status = value.Status;
      let status_button;
      let action_buttons = '';
      const action_buttons_array = [0,0,0]; //Xem, nop bai, dat lich
      switch(status){
        case 1:
          status_button = 
          `<button type="button" class="btn btn-primary">
            Open
          </button>`;
          if(value.Required_File){
            action_buttons_array[1] = 1;
          }
          if(value.Required_Interview){
            action_buttons_array[2] = 1;
          }
          break;
        case 2:
          status_button = 
          `<button type="button" class="btn btn-secondary">File Submitted</button>`;
          action_buttons_array[0] = 1;
          action_buttons_array[2] = 1;
          break;
        case 3:
          status_button = 
          `<button type="button" class="btn btn-info">
            Submitted
          </button>`;
          action_buttons_array[0] = 1;
          break;
        case 4:
          status_button = 
          `<button type="button" class="btn btn-primary">Assigned</button>`;
          action_buttons_array[0] = 1;
          break;
        case 5:
          status_button = 
          `<button type="button" class="btn btn-success">
              Passed
          </button>`;
          action_buttons_array[0] = 1;
          break;
        case 6:
          status_button = 
          `<button type="button" class="btn btn-danger">
              Not Passed
            </button>`;
          action_buttons_array[0] = 1;
          if(!value.Required_File&&value.Required_Interview&&value.Review_times&&value.Review_times<value.Review_times_max){
            action_buttons_array[2] = 1;
          }
          if(value.Required_File&&!value.Required_Interview){
            action_buttons_array[1] = 1;
          }
          if(value.asssessment_type_title ==="Assignment" && value.Required_File&&value.Required_Interview){
            if(value.Mark > 0){
              action_buttons_array[1] = 1;
            }
            if(value.Mark ===0 && value.Review_times && value.Review_times<value.Review_times_max){
              action_buttons_array[1] = 1;
              action_buttons_array[2] = 1;
            }
          }
          if(value.asssessment_type_title!=="Assignment"&&value.Required_File&&value.Required_Interview){
            if(value.Review_times && value.Review_times<value.Review_times_max){
              action_buttons_array[1] = 1;
              action_buttons_array[2] = 1;
            }
          }
          break;
        default:
          console.log('Error in API');
      }
      if(action_buttons_array[0]){
        if(value.asssessment_type_title==="Assignment"){
          action_buttons += 
          `<button type="button" class="btn btn-primary" onclick="showViewPageForAsm()">
              Xem
          </button>`;
        }else{
          action_buttons += 
          `<button type="button" class="btn btn-primary" onclick="showViewPage()">
              Xem
          </button>`;
        }
      }
      if(action_buttons_array[1]){
        action_buttons += 
        `<button type="button" class="btn btn-primary" id="`+title+`" onclick="showSubmitFilePage(event)">
            Nộp bài
        </button>`;
      }
      if(action_buttons_array[2]){
        action_buttons += 
        `<button type="button" class="btn btn-primary" onclick="showBookPage()">
            Đặt lịch
        </button>`;
      }
      const template = 
        `<tr>
          <th scope="row">`+(i+1)+`</th>
          <td>`+title+`</td>
          <td>`+status_button+`</td>
          <td>
            <div
              class="btn-group"
              role="group"
              aria-label="Basic example"
            >`+action_buttons+`
            </div>
          </td>
        </tr>`;
      $('#table-1-body').append(template);
    }
  });

  function showViewPageForAsm(){
    
    const main_page = document.getElementById("main-page");
    main_page.style.display = 'none';

    const view_page = document.getElementById("view-page");
    view_page.style.display = 'block';

    fetch('http://51.79.153.64:3000/view_asm')
    .then(res => res.json())
    .then(data => {
      try{
        $('#title').append(data.asssessment_element_title);
        $('#course-code').append(data.course_code);
        $('#date-register').append(data.date_register+`<span>`+ data.time_register + `</span>`);
        $('#datetime-interview').append(data.datetime_interview);
        $('#review-times').append(data.Review_times+` \ `+data.Review_times_max);
        $('#mentor-email').append(data.Mentor_email);
        if(data.Option_selected){
          $('#option').append(data.Option_selected);
        }else{
          $('#select-form').hide()
        }
        $('#mark').append(data.Mark);
        $('#comment').append(data.Comment_Mentor);
        let status_button;
        switch(data.Status){
          case 1:
            status_button = 
            `<button type="button" class="btn btn-primary">
              Open
            </button>`;
            break;
          case 2:
            status_button = 
            `<button type="button" class="btn btn-secondary">File Submitted</button>`;
            break;
          case 3:
            status_button = 
            `<button type="button" class="btn btn-info">
              Submitted
            </button>`;
            break;
          case 4:
            status_button = 
            `<button type="button" class="btn btn-primary">Assigned</button>`;
            break;
          case 5:
            status_button = 
            `<button type="button" class="btn btn-success">
                Passed
            </button>`;
            break;
          case 6:
            status_button = 
            `<button type="button" class="btn btn-danger">
                Not Passed
              </button>`;
            break;
          default:
            console.log('Error in API');
          }
          $('#status-button').append(status_button);
          const details = data.Criteria_detail;
          let details_template = '';
          details.forEach(function (value, i) {
            details_template +=
            `<tr>
              <th scope="row">`+i+`</th>
              <td>`+value.Weight+`</td>
              <td>`+value.Criteria_desc+`</td>
              <td>`+value.Criteria_Mark+`</td>
              <td>`+value.Criteria_Comment+`</td>
              <td>`+value.Mandatory+`</td>
            </tr>`
          });
          $('#details').append(details_template);
      }catch(err){
        console.log(err);
      }
    });
  }

  function showViewPage(){
    
    const main_page = document.getElementById("main-page");
    main_page.style.display = 'none';

    const view_page = document.getElementById("view-page");
    view_page.style.display = 'block';

    fetch('http://51.79.153.64:3000/view_asm')
    .then(res => res.json())
    .then(data => {
      try{
        $('#title').append(data.asssessment_element_title);
        $('#course-code').append(data.course_code);
        $('#date-register').append(data.date_register+`<span>`+ data.time_register + `</span>`);
        $('#datetime-interview').append(data.datetime_interview);
        $('#review-times').append(data.Review_times+` \ `+data.Review_times_max);
        $('#mentor-email').append(data.Mentor_email);
        if(data.Option_selected){
          $('#option').append(data.Option_selected);
        }else{
          $('#select-form').hide()
        }
        $('#mark').append(data.Mark);
        $('#comment').append(data.Comment_Mentor);
        let status_button;
        switch(data.Status){
          case 1:
            status_button = 
            `<button type="button" class="btn btn-primary">
              Open
            </button>`;
            break;
          case 2:
            status_button = 
            `<button type="button" class="btn btn-secondary">File Submitted</button>`;
            break;
          case 3:
            status_button = 
            `<button type="button" class="btn btn-info">
              Submitted
            </button>`;
            break;
          case 4:
            status_button = 
            `<button type="button" class="btn btn-primary">Assigned</button>`;
            break;
          case 5:
            status_button = 
            `<button type="button" class="btn btn-success">
                Passed
            </button>`;
            break;
          case 6:
            status_button = 
            `<button type="button" class="btn btn-danger">
                Not Passed
              </button>`;
            break;
          default:
            console.log('Error in API');
          }
          $('#status-button').append(status_button);

          const details_view = document.getElementById("details-view");
          details_view.style.display = 'none';
          
      }catch(err){
        console.log(err);
      }
    });
  }

  function showSubmitFilePage(event){
    const main_page = document.getElementById("main-page");
    main_page.style.display = 'none';

    const submit_file_page = document.getElementById("submit-file-page");
    submit_file_page.style.display = 'block';

    const title = event.target.id;
    $('#submit-view-title').append(title);
  }

  function showBookPage(){
    const main_page = document.getElementById("main-page");
    main_page.style.display = 'none';

    const book_page = document.getElementById("book-page");
    book_page.style.display = 'block';
  }

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>